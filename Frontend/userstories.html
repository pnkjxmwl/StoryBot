<!DOCTYPE html>
<html>
<head>
  <title>User Stories</title>
  <style>
    .storyBox {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px;
      width: 200px;
      cursor: pointer;
    }

    .storyBox img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <nav id="navbar" style="display: block;">
    <ul>
      <li><a href="file:///D:/PROGRAM/Projects/StoryBot/Frontend/community.html">Community</a></li>
      <li><a href="file:///D:/PROGRAM/Projects/StoryBot/Frontend/main.html">Home</a></li>
      <li><a href="#" id="logoutButton">Logout</a></li>
    </ul>
  </nav>

  <h1> <span id="username"></span> Stories</h1>
  <div id="userStoriesContainer"></div>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    (async function() {
      const jwtToken = localStorage.getItem('jwtToken');
      
      function checkJWTToken() {
        return jwtToken ? true : false;
      }

      // Function to redirect to the main page
      function redirectToMainPage() {
        window.location.href = 'file:///D:/PROGRAM/Projects/StoryBot/Frontend/main.html';
      }

      // Function to delete the JWT token and redirect to the main page
      function logout() {
        localStorage.removeItem('jwtToken');
        redirectToMainPage();
      }

      // Handle click event for the logout button
      document.getElementById('logoutButton').addEventListener('click', () => {
        logout();
      });

      if (checkJWTToken()) {
        const user = await getuser(jwtToken);
        console.log(user);
        axios.get('http://127.0.0.1:4000/api/v1/user', {
          params: {
            id: user._id
          }
        })
        .then((response) => {
          console.log(response)
          userStories = response.data.data.stories;
          const ele = document.getElementById('username');
          ele.innerText = response.data.data.name;
          const userStoriesContainer = document.getElementById('userStoriesContainer');
          userStories.forEach(story => {
            const storyDiv = document.createElement('div');
             storyDiv.classList.add('storyBox');
            
             const h2Tag = document.createElement('h2');
            h2Tag.textContent = story.title;
            
          const imgTag = document.createElement('img');
          imgTag.setAttribute('src', story.images[0]);

          storyDiv.appendChild(h2Tag);
          storyDiv.appendChild(imgTag);

          storyDiv.addEventListener('click', () => {
            // Redirect to the story page with the full story content
            window.location.href = `file:///D:/PROGRAM/Projects/StoryBot/Frontend/story.html?storyId=${story._id}`;
          }); 
            
            userStoriesContainer.appendChild(storyDiv);
          });

        })
        .catch((error) => {
          console.log(error);
        });
      } else {
        redirectToMainPage();
      }

      async function getuser(jwtToken) {
        const response = await fetch('http://127.0.0.1:4000/api/v1/isAuthenticated', {
          method: 'GET',
          headers: {
            'x-access-token': jwtToken, // Attach the JWT token as x-access-token in the headers
          }
        });
        const data = await response.json();
        console.log(data);
        return data.data
      }
    })();
  </script>
</body>
</html>
